<nav dir="rtl" class="w-full px-4 py-2 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 text-sm font-medium" data-controller="toggle">
  <% system_admin_mode = false %>
  <% community_mode = false %>
  <% if user_signed_in? %>
    <% system_admin_mode = current_user.system_admin? && session[:selected_community_id].blank? %>
    <% community_mode = !current_user.system_admin? || session[:selected_community_id].present? %>
  <% end %>
  <div class="flex w-full items-center justify-between">
    <div class="flex items-center gap-6">
      <div class="flex items-center flex-shrink-0">
        <%= link_to root_path, class: "flex items-center text-gray-700 hover:text-gray-800 dark:text-gray-100 dark:hover:text-gray-300" do %>
          <span class="sr-only"><%= Jumpstart.config.application_name %></span>
          <span class="text-xl font-bold">הקהל</span>
        <% end %>
      </div>

      <% if user_signed_in? %>
        <% if system_admin_mode %>
          <%= link_to "מנהל מערכת", hke_admin_root_path, class: "text-blue-600 font-semibold" %>
          <%= link_to "קהילות", hke_admin_communities_path %>
          <%= link_to "משתמשים", madmin_users_path %>
          <%= link_to t('community_admin.navbar.logs', default: '\u05dc\u05d5\u05d2\u05d9\u05dd'), hke_logs_path %>
          <%= link_to "העדפות", hke_system_preferences_path %>
        <% elsif community_mode %>
          <%= link_to t('community_admin.navbar.message_approval'), hke_root_path, class: "text-green-600 font-semibold" %>
          <%= link_to t('community_admin.navbar.deceased_people'), hke_deceased_people_path %>
          <%= link_to t('community_admin.navbar.contact_people'), hke_contact_people_path %>
          <%= link_to t('community_admin.navbar.import_csv'), hke_csv_imports_path %>
          <%= link_to t('community_admin.navbar.message_management'), hke_message_management_index_path %>
          <%= link_to t('community_admin.navbar.logs', default: '\u05dc\u05d5\u05d2\u05d9\u05dd'), hke_logs_path %>
          <%= link_to "העדפות", hke_community_preferences_path %>

        <% end %>
      <% end %>

      <%= render "shared/left_nav" rescue nil %>
      <%= render "shared/right_nav" rescue nil %>
    </div>

    <div class="flex items-center gap-4">
      <% if user_signed_in? %>
        <% if system_admin_mode %>
          <div class="flex items-center space-x-2 space-x-reverse">
            <%= form_with url: hke_admin_switch_to_community_path, method: :post, local: true do |form| %>
              <%= form.select :community_id,
                  options_from_collection_for_select(Hke::Community.order(:name), :id, :name, nil),
                  { prompt: t('admin.dashboard.community_switching.switch_to_community') },
                  { class: "w-64 p-2 px-8 border rounded text-right", dir: "rtl", autocomplete: "off", onchange: "this.form.submit();" } %>
            <% end %>
          </div>
        <% end %>

        <div class="hidden lg:inline-block">
          <%= render "shared/notifications" rescue nil %>
        </div>

        <% if community_mode && current_user.system_admin? %>
          <%= link_to t('admin.dashboard.community_switching.back_to_system_admin'),
              hke_admin_switch_to_community_path,
              data: { turbo_method: :post },
              class: "px-4 py-2 text-blue-600 hover:text-blue-800 font-medium" %>
        <% end %>

        <div class="relative group ml-2">
          <button class="flex items-center px-4 py-2 text-gray-700 hover:text-gray-900 font-medium">
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
            <%= image_tag AvatarHelper.avatar_url_for(current_user, size: 48), alt: current_user.name || current_user.email, class: "h-8 w-8 rounded-full ring-2 ring-gray-200 ml-2" %>
            <%= current_user.name.presence || current_user.email %>
          </button>
          <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
            <%= link_to t('profile'), main_app.edit_user_registration_path,
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
            <%= link_to t('logout'), main_app.destroy_user_session_path,
                data: { turbo_method: :delete, turbo_confirm: t('are_you_sure') },
                class: "block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" %>
          </div>
        </div>

        <button type="button" id="sidebar-open" class="flex items-center p-3 text-gray-500 lg:hidden focus:outline-none focus:text-gray-700" data-action="click->toggle#toggle touch->toggle#toggle">
          <svg class="w-5 h-5 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path></svg>
        </button>
      <% else %>
        <%= link_to t(".log_in", default: "Log in"), main_app.new_user_session_path, class: "nav-link" %>
        <%= link_to t(".sign_up", default: "Sign up"), main_app.new_user_registration_path, class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <% if user_signed_in? && defined?(current_account) && current_account.present? %>
  <div class="flex-grow hidden w-full pb-6 lg:flex lg:w-auto lg:pb-0"
        data-toggle-target="toggleable"
        data-transition-enter="transition-all ease-linear duration-300"
        data-transition-enter-from="opacity-0 h-0"
        data-transition-enter-to="opacity-100"
        data-transition-leave="transition-all ease-linear duration-300"
        data-transition-leave-from="opacity-100"
        data-transition-leave-to="opacity-0">
    <!-- Mobile menu -->
    <div class="lg:hidden mt-2 pt-4 pb-2 border-t border-gray-200">
      <div class="flex items-center px-2">
        <div><%= account_avatar current_account, include_user: true, class: "rounded-full h-10 w-10" %></div>
        <div class="grow ml-3">
          <div class="text-base font-medium text-gray-800"><%= current_account.name %></div>
        </div>
        <%= link_to main_app.notifications_path, class: "ml-auto p-1 rounded-full text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
          <span class="sr-only">View notifications</span>
          <svg class="h-6 w-6" x-description="Heroicon name: outline/bell" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
          </svg>
        <% end %>
      </div>
      <div class="mt-3 space-y-1">
        <%= link_to t(".profile"), main_app.edit_user_registration_path, class: "block p-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-50 dark:bg-gray-900 dark:hover:bg-primary-800" %>
        <%= link_to t(".accounts"), main_app.accounts_path, class: "block p-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-50 dark:bg-gray-900 dark:hover:bg-primary-800" %>
        <% if current_user.admin? %>
          <%= link_to t(".admin", default: "Admin"), hke_admin_root_path, class: "block p-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-50 dark:bg-gray-900 dark:hover:bg-primary-800", data: { turbo: false } %>
        <% end %>
        <%= button_to t(".sign_out"),
              main_app.destroy_user_session_path,
              method: :delete,
              form: { data: { turbo: false } },
              class: "w-full text-left block p-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 dark:text-gray-50 dark:bg-gray-900 dark:hover:bg-primary-800" %>
      </div>
    </div>

    <!-- Main menu -->
    <div class="hidden lg:inline-flex z-10 items-center leading-none no-underline align-middle rounded text-gray-700 hover:text-gray-800 dark:text-gray-50 dark:hover:text-gray-200">
      <div class="relative flex flex-row-reverse" data-controller="dropdown">
        <button data-action=" click@window->dropdown#hide" role="button" class="inline-block select-none" aria-label="Profile Menu">
          <span class="flex flex-row-reverse items-center text-gray-700 dark:text-gray-100 appearance-none">
            <%= account_avatar current_account, include_user: true, class: "rounded-full h-8 w-8 ring-2 ring-transparent hover:ring-gray-400 dark:hover:ring-gray-100" %>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current w-4 h-4"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"></path></svg>
          </span>
        </button>
        <div data-dropdown-target="menu"
              data-transition-enter="transition ease-out duration-200"
              data-transition-enter-from="opacity-0 translate-y-1"
              data-transition-enter-to="opacity-100 translate-y-0"
              data-transition-leave="transition ease-in duration-150"
              data-transition-leave-from="opacity-100 translate-y-0"
              data-transition-leave-to="opacity-0 translate-y-1"
              class="z-20 hidden mt-2 lg:absolute lg:left-0 dropdown-menu">
          <div class="overflow-hidden bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded shadow-md">
            <%= link_to current_account.name, main_app.account_path(current_account.id), class: "border-b border-gray-200 dark:border-gray-700 font-semibold text-base text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover:bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" %>
            <%= link_to t(".profile"), main_app.edit_user_registration_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover:bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" %>
            <%= link_to t(".password"), main_app.account_password_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" %>
            <%= link_to t(".connected_accounts"), main_app.user_connected_accounts_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" if Devise.omniauth_configs.any? %>
            <%= link_to t(".billing"), main_app.subscriptions_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" if Jumpstart.config.payments_enabled? %>
            <%= link_to t(".accounts"), main_app.accounts_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3" %>
        <% other_accounts = current_user.accounts.order(name: :asc).where.not(id: current_account.id) %>
        <% if other_accounts.any? %>
              <div class="px-6 py-3 text-xs font-bold text-gray-800 uppercase bg-white dark:text-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">Switch Account</div>
          <% other_accounts.each do |account| %>
                <%= switch_account_button account, data: { controller: :accounts, action: "ajax:success->accounts#reconnect" }, class: "w-full text-left text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3 cursor-pointer" %>
              <% end %>
            <% end %>
            <% if current_user.admin? %>
              <div class="px-6 py-3 text-xs font-bold text-gray-800 uppercase bg-white dark:text-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700"><%= t(".admin") %></div>
              <%= link_to t(".dashboard"), hke_admin_root_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3", target: :_blank, data: { turbo: false } %>
              <% if defined?(::Sidekiq) && main_app.respond_to?(:admin_sidekiq_web_path) %>
                <%= link_to "Sidekiq", main_app.admin_sidekiq_web_path, class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3", target: :_blank, data: { turbo: false } %>
              <% end %>
            <% end %>
            <% if Rails.env.development? %>
              <div class="px-6 py-3 text-xs font-bold text-gray-800 uppercase bg-white dark:text-gray-50 dark:bg-gray-800 border-t border-gray-200 dark-border-gray-700">Development</div>
              <%= link_to "Jumpstart Config", main_app.jumpstart_path(script_name: nil), class: "text-gray-800 bg-white hover:bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3", data: { turbo: false } %>
              <%= link_to "Jumpstart Docs", jumpstart.docs_path, class: "text-gray-800 bg-white hover_bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3", target: :_blank, data: { turbo: false } %>
              <% if main_app.respond_to?(:letter_opener_web_path) %>
                <%= link_to "Letter Opener", main_app.letter_opener_web_path(script_name: nil), class: "text-gray-800 bg-white hover_bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap no-underline block px-6 py-3", target: :_blank, data: { turbo: false } %>
              <% end %>
            <% end %>
            <%= button_to t(".sign_out"), main_app.destroy_user_session_path, method: :delete, class: "w-full text-left font-medium cursor-pointer px-6 py-3 border-t border-gray-200 dark:border-gray-700 text-gray-800 bg-white hover_bg-primary-50 dark:text-gray-50 dark:bg-gray-800 dark:hover_bg-primary-800 transition ease-in-out duration-200 whitespace-nowrap" %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</nav>
