<style>
  table.hke-log-table {
    table-layout: fixed;
    width: 100%;
    border-collapse: collapse;
  }

  table.hke-log-table th,
  table.hke-log-table td {
    border: 1px solid #ccc;
    padding: 4px 8px;
    text-align: right;
    word-break: break-word;
    vertical-align: top;
  }

  .col-date   { width: 150px; }
  .col-event  { width: 220px; }
  .col-entity { width: 170px; }
</style>

<div style="padding-left: 1rem; padding-right: 1rem;">
  <table class="hke-log-table text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="col-date"><%= sort_link("event_time", "תאריך") %></th>
        <th class="col-event"><%= sort_link("event_type", "אירוע") %></th>
        <th class="col-entity"><%= sort_link("entity_type", "ישות") %></th>
        <th>פרטים</th>
      </tr>
    </thead>

    <tbody>
      <% @logs.each do |log| %>
        <% details = log.details || {} %>

        <% build_line = ->(d) do
          parts = []
          parts << "מצב:#{d["mode"]}"
          parts << "קשר:#{d["relation_id"]}"
          parts << "נפטר:#{d["deceased_id"]}"
          parts << "איש קשר:#{d["contact_id"]}"
          parts << "יארצייט:#{d["yahrzeit_date"]}"
          parts << "אופסטים:#{Array(d["offsets"]).join(",")}"
          parts << "שליחה:#{d["computed_send_date"]}"
          parts << "עדיפות:#{Array(d["delivery_priority"]).join(",")}"
          parts << "שיטה:#{d["chosen_delivery_method"]}"
          parts << "טלפון✓" if d["phone_present"]
          parts << "אימייל✓" if d["email_present"]
          parts.compact.join(" | ")
        end %>

        <% diff_line = ->(label_key, arr) do
          return nil unless arr.is_a?(Array) && arr.size == 2
        
          key = label_key.to_s
          old_v, new_v = arr
        
          fmt = ->(v) do
            begin
              v.is_a?(String) && v.include?("T") ? Time.parse(v).to_date : v
            rescue StandardError
              v
            end
          end
        
          label = t("hke.logs.labels.#{key}", default: key)
          gender = t("hke.logs.label_gender.#{key}", default: "m")
        
          old_label = t("hke.logs.change_old.#{gender}", label: label)
          new_label = t("hke.logs.change_new.#{gender}", label: label)
        
          "#{old_label}: #{fmt.call(old_v)} -> #{new_label}: #{fmt.call(new_v)}"
        end %>

        <% human_details =
          case log.event_type
          when "future_message_build"
            build_line.call(details)
          else
            case log.entity_type
            when "Hke::DeceasedPerson"
              [
                "שם: #{details["first_name"]} #{details["last_name"]}",
                "תאריך פטירה: #{details["date_of_death"]}",
              ].compact.join("; ")
            when "Hke::ContactPerson"
              [
                "שם: #{details["first_name"]} #{details["last_name"]}",
                "טלפון: #{details["phone"]}",
                (details["email"].present? ? "אימייל: #{details["email"]}" : nil),
              ].compact.join("; ")
            when "Hke::Relation"
              [
                "קשר: #{details["relation_of_deceased_to_contact"]}",
                "Contact: #{details["contact_person_id"]}",
                "Deceased: #{details["deceased_person_id"]}",
              ].join("; ")
            when "Hke::FutureMessage"
              lines = []
              lines << diff_line.call(:send_date, details["send_date"])
              lines << diff_line.call(:delivery_method, details["delivery_method"])
              lines << diff_line.call(:email, details["email"])
              lines << diff_line.call(:phone, details["phone"])
        
              lines.compact.join(" | ").presence ||
                details.map { |k, v| "#{h k}: #{h v}" }.join(" | ")
            when "Hke::SentMessage"
              [
                (
                  if details["full_message"].present?
                    "הודעה: #{h details["full_message"]}"
                  end
                ),
                ("טלפון: #{h details["phone"]}" if details["phone"].present?),
              ].compact.join(" | ")
            else
              details.map { |k, v| "<strong>#{h k}:</strong> #{h v}" }.join("<br>")
            end
          end %>

        <tr>
          <td class="col-date"><%= log.event_time.strftime("%H:%M:%S.%L %m/%d") %></td>
          <td class="col-event"><%= log.event_type %></td>
          <td class="col-entity"><%= [log.entity_type&.demodulize, log.entity_id].compact.join("#") %></td>
          <td><%= human_details.to_s.html_safe %></td>
        </tr>

      <% end %>
    </tbody>
  </table>
</div>
