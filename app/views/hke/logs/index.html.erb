<div class="px-4 py-6" dir="rtl">

  <%# ─── Header ─── %>
  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">
        <%= t("hke.logs.index.title",
              count: @total_count,
              from_date: @earliest_date ? l(@earliest_date, format: "%d/%m/%Y") : "—") %>
      </h1>
      <p class="text-sm text-gray-500 mt-0.5">יומן פעולות המערכת</p>
    </div>
    <% if @total_count > 0 %>
      <%= link_to t("hke.logs.index.clear_all"),
            destroy_all_hke_logs_path,
            class: "inline-flex items-center gap-1.5 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium
                    hover:bg-red-700 active:bg-red-800 transition-colors whitespace-nowrap shadow-sm",
            data: {
              turbo_method: :delete,
              turbo_confirm: t("hke.logs.index.clear_all_confirm"),
            } %>
    <% end %>
  </div>

  <%# ─── Filters bar ─── %>
  <%= form_tag(request.path, method: :get,
        class: "bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 flex flex-wrap items-end gap-4 mb-6 text-sm",
        dir: "rtl", data: { turbo: false }) do %>
    <%= hidden_field_tag :sort,      params[:sort]      if params[:sort].present? %>
    <%= hidden_field_tag :direction, params[:direction] if params[:direction].present? %>
    <%= hidden_field_tag :start,     params[:start]     if params[:start].present? %>
    <%= hidden_field_tag :end,       params[:end]       if params[:end].present? %>

    <div class="flex flex-wrap gap-4">
      <%# Event-type filter %>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          <%= t("hke.logs.index.filter_event_type") %>
        </label>
        <select name="event_type"
                class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm bg-white shadow-sm
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                onchange="this.form.submit()">
          <option value=""><%= t("hke.logs.index.filter_all") %></option>
          <% @event_types.each do |et| %>
            <option value="<%= et %>" <%= "selected" if params[:event_type] == et %>><%= et %></option>
          <% end %>
        </select>
      </div>

      <%# Entity-type filter %>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          <%= t("hke.logs.index.filter_entity_type") %>
        </label>
        <select name="entity_type"
                class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm bg-white shadow-sm
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                onchange="this.form.submit()">
          <option value=""><%= t("hke.logs.index.filter_all") %></option>
          <% @entity_types.each do |et| %>
            <option value="<%= et %>" <%= "selected" if params[:entity_type] == et %>><%= et.demodulize %></option>
          <% end %>
        </select>
      </div>

      <%# Per-page selector %>
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          <%= t("hke.logs.index.per_page") %>
        </label>
        <select name="per_page"
                class="border border-gray-300 rounded-lg px-3 py-1.5 text-sm bg-white shadow-sm
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                onchange="this.form.submit()">
          <% %w[50 100 250 500 all].each do |n| %>
            <option value="<%= n %>" <%= "selected" if @per_page.to_s == n %>>
              <%= n == "all" ? t("hke.logs.index.per_page_all") : n %>
            </option>
          <% end %>
        </select>
      </div>
    </div>
  <% end %>

  <%# ─── Table ─── %>
  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
    <table class="w-full text-sm text-right border-collapse">
      <thead>
        <tr class="bg-gray-100 border-b border-gray-200 text-gray-600 text-xs font-semibold uppercase tracking-wide">
          <th class="px-4 py-3 w-36"><%= sort_link("event_time", "תאריך") %></th>
          <th class="px-4 py-3 w-44"><%= sort_link("event_type", "אירוע") %></th>
          <th class="px-4 py-3 w-44"><%= sort_link("entity_type", "ישות") %></th>
          <th class="px-4 py-3">פרטים</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        <% @logs.each_with_index do |log, i| %>
          <% details = log.details || {} %>

          <% build_line = ->(d) do
            parts = []
            parts << "מצב:#{d["mode"]}"
            parts << "קשר:#{d["relation_id"]}"
            parts << "נפטר:#{d["deceased_id"]}"
            parts << "איש קשר:#{d["contact_id"]}"
            parts << "יארצייט:#{d["yahrzeit_date"]}"
            parts << "אופסטים:#{Array(d["offsets"]).join(",")}"
            parts << "שליחה:#{d["computed_send_date"]}"
            parts << "עדיפות:#{Array(d["delivery_priority"]).join(",")}"
            parts << "שיטה:#{d["chosen_delivery_method"]}"
            parts << "טלפון✓" if d["phone_present"]
            parts << "אימייל✓" if d["email_present"]
            parts.compact.join(" | ")
          end %>

          <% diff_line = ->(label_key, arr) do
            return nil unless arr.is_a?(Array) && arr.size == 2
            key = label_key.to_s
            old_v, new_v = arr
            fmt = ->(v) do
              begin
                v.is_a?(String) && v.include?("T") ? Time.parse(v).to_date : v
              rescue StandardError
                v
              end
            end
            label    = t("hke.logs.labels.#{key}", default: key)
            gender   = t("hke.logs.label_gender.#{key}", default: "m")
            old_label = t("hke.logs.change_old.#{gender}", label: label)
            new_label = t("hke.logs.change_new.#{gender}", label: label)
            "#{old_label}: #{fmt.call(old_v)} → #{new_label}: #{fmt.call(new_v)}"
          end %>

          <% human_details =
            case log.event_type
            when "future_message_build"
              build_line.call(details)
            else
              case log.entity_type
              when "Hke::DeceasedPerson"
                [
                  "שם: #{details["first_name"]} #{details["last_name"]}",
                  "תאריך פטירה: #{details["date_of_death"]}",
                ].compact.join(" · ")
              when "Hke::ContactPerson"
                [
                  "שם: #{details["first_name"]} #{details["last_name"]}",
                  "טלפון: #{details["phone"]}",
                  (details["email"].present? ? "אימייל: #{details["email"]}" : nil),
                ].compact.join(" · ")
              when "Hke::Relation"
                [
                  "קשר: #{details["relation_of_deceased_to_contact"]}",
                  "Contact: #{details["contact_person_id"]}",
                  "Deceased: #{details["deceased_person_id"]}",
                ].join(" · ")
              when "Hke::FutureMessage"
                lines = []
                lines << diff_line.call(:send_date, details["send_date"])
                lines << diff_line.call(:delivery_method, details["delivery_method"])
                lines << diff_line.call(:email, details["email"])
                lines << diff_line.call(:phone, details["phone"])
                lines.compact.join(" | ").presence ||
                  details.map { |k, v| "#{h k}: #{h v}" }.join(" | ")
              when "Hke::SentMessage"
                [
                  (details["full_message"].present? ? "הודעה: #{h details["full_message"]}" : nil),
                  (details["phone"].present? ? "טלפון: #{h details["phone"]}" : nil),
                ].compact.join(" | ")
              else
                details.map { |k, v| "<strong>#{h k}:</strong> #{h v}" }.join("<br>")
              end
            end %>

          <%# Event-type badge colours %>
          <% event_badge_class = case log.event_type
            when "create"               then "bg-emerald-100 text-emerald-700"
            when "update"               then "bg-blue-100 text-blue-700"
            when "destroy", "delete"    then "bg-red-100 text-red-700"
            when "future_message_build" then "bg-violet-100 text-violet-700"
            else                             "bg-gray-100 text-gray-600"
            end %>

          <%# Entity badge colours %>
          <% entity_badge_class = case log.entity_type
            when "Hke::DeceasedPerson"  then "bg-slate-100 text-slate-600"
            when "Hke::ContactPerson"   then "bg-amber-100 text-amber-700"
            when "Hke::Relation"        then "bg-cyan-100 text-cyan-700"
            when "Hke::FutureMessage"   then "bg-indigo-100 text-indigo-700"
            when "Hke::SentMessage"     then "bg-teal-100 text-teal-700"
            when "User"                 then "bg-pink-100 text-pink-700"
            else                             "bg-gray-100 text-gray-500"
            end %>

          <tr class="<%= i.even? ? "bg-white" : "bg-gray-50/60" %> hover:bg-blue-50/40 transition-colors">

            <%# Date/time %>
            <td class="px-4 py-2.5 align-top whitespace-nowrap font-mono text-xs text-gray-500">
              <div class="font-medium text-gray-700"><%= log.event_time.strftime("%d/%m %H:%M:%S") %></div>
            </td>

            <%# Event type badge %>
            <td class="px-4 py-2.5 align-top">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-semibold <%= event_badge_class %>">
                <%= log.event_type %>
              </span>
            </td>

            <%# Entity badge %>
            <td class="px-4 py-2.5 align-top">
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium <%= entity_badge_class %>">
                <%= log.entity_type&.demodulize %>
                <% if log.entity_id.present? %>
                  <span class="opacity-60">#<%= log.entity_id %></span>
                <% end %>
              </span>
            </td>

            <%# Details %>
            <td class="px-4 py-2.5 align-top text-gray-600 leading-relaxed break-words max-w-0 w-full">
              <%= human_details.to_s.html_safe %>
            </td>

          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%# ─── Pagination ─── %>
  <% if @pagy.last > 1 %>
    <div class="text-center mt-6">
      <%== @pagy.series_nav %>
    </div>
  <% end %>

</div>
