<% profile_mode = local_assigns.fetch(:profile_mode, @profile_mode) %>
<% form_url = profile_mode ? profile_hke_users_path : [:hke, user] %>
<% form_method = profile_mode ? :patch : (user.persisted? ? :patch : :post) %>

<%= form_with(model: user, url: form_url, method: form_method, data: { turbo: false }, autocomplete: "off") do |form| %>
  <%= render "shared/error_messages", resource: form.object %>

  <div class="flex items-center justify-between mb-4 h4">
    <% if profile_mode %>
      <%= t("users.profile.title", default: "הפרופיל שלי") %>
    <% elsif @user.persisted? %>
      <%= t("users.edit.title") + ": #{@user.name}" %>
    <% else %>
      <%= t("users.new.title") %>
    <% end %>
    <div class="mr-auto flex">
      <%= form.button t("save"), class: "btn btn-link" %>
      <% if !profile_mode && form.object.persisted? && form.object != current_user %>
        <%= link_to t("delete"),
        hke_user_path(form.object),
        class: "btn btn-link",
        data: {
          turbo_method: :delete,
          turbo_confirm: t("are_you_sure"),
        } %>
      <% end %>
      <% cancel_path =
        profile_mode ? (session[:profile_return_to] || hke_root_path) : hke_users_path %>
      <%= link_to t("cancel"), cancel_path, class: "btn btn-link" %>
    </div>
  </div>

  <%= render "user_fields", form: form, profile_mode: profile_mode %>

<% end %>
